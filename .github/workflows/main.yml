name: CI/CD pipeline

on:
  push:
    branches:
      - main

env:
  DOCKER_BUILDKIT: 1

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Build and push Docker image
        env:
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          docker build -t finalndbikeoperation .
          docker tag finalndbikeoperation $ACR_REGISTRY/finalndbikeoperation:latest
          echo $ACR_PASSWORD | docker login -u $ACR_USERNAME --password-stdin $ACR_REGISTRY
          docker push $ACR_REGISTRY/finalndbikeoperation:latest
  deploy-to-container-instance:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - name: Deploy to Azure Container Instance
        uses: azure/container-instances@v1
        with:
          resource-group: ${{ secrets.RESOURCE_GROUP }}
          name: ${{ secrets.CONTAINER_GROUP_NAME }}
          image: ${{ secrets.ACR_REGISTRY }}/finalndbikeoperation:latest
          cpu: 1
          memory: 1.5
          command: "'echo', 'Hello, dotnet!'"
