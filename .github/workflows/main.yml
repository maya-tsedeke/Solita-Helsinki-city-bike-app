name: CI/CD pipeline

on:
  push:
    branches:
      - main

env:
  DOCKER_BUILDKIT: 1
  AZURE_RG: <your-resource-group-name>
  AZURE_SUBSCRIPTION: <your-subscription-id>

jobs:
  create-service-principal:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Create Service Principal
        run: |
          az ad sp create-for-rbac --name AcrPush --role owner --scopes /subscriptions/${{ env.AZURE_SUBSCRIPTION }}/resourceGroups/${{ env.AZURE_RG }} --sdk-auth > sp.json
        env:
          AZURE_SUBSCRIPTION: ${{ secrets.AZURE_SUBSCRIPTION }}
          AZURE_RG: ${{ secrets.AZURE_RG }}
      - name: Save Service Principal to Secrets
        uses: azure/CLI@v1
        with:
          azcliversion: 2.0.72
          inlineScript: |
            SP_JSON=$(cat sp.json)
            echo "::set-secret name=AZURE_CREDENTIALS::${SP_JSON}"
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Build and push Docker image
        env:
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          docker build -t finalndbikeoperation .
          docker tag finalndbikeoperation $ACR_REGISTRY/finalndbikeoperation:latest
          echo $ACR_PASSWORD | docker login -u $ACR_USERNAME --password-stdin $ACR_REGISTRY
          docker push $ACR_REGISTRY/finalndbikeoperation:latest
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - name: Deploy to Azure Container Instance
        uses: Azure/aci-deploy@v1
        with:
          resource-group: ${{ secrets.RESOURCE_GROUP }}
          name: ${{ secrets.CONTAINER_GROUP_NAME }}
          image: ${{ secrets.ACR_REGISTRY }}/finalndbikeoperation:latest
          cpu: 1
          memory: 1.5
          command: "'echo', 'Hello, dotnet!'"
