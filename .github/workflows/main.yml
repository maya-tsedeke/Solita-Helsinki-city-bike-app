name: CI/CD pipeline
on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Build and push Docker image
        run: ./build-and-push.sh ${{ secrets.ACR_REGISTRY }} ${{ secrets.ACR_USERNAME }} ${{ secrets.ACR_PASSWORD }}
        env:
          DOCKER_BUILDKIT: 1
  deploy-to-container-instance:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - name: Deploy to Azure Container Instance
        uses: azure/container-instances@v1
        with:
          resource-group: ${{ secrets.RESOURCE_GROUP }}
          name: ${{ secrets.CONTAINER_GROUP_NAME }}
          image: ${{ secrets.ACR_REGISTRY }}/finalndbikeoperation:latest
          cpu: 1
          memory: 1.5
          command: "echo 'Hello, dotnet!'"

